<!doctype html><html lang=en-us><head><title>Fix RootFS related errors in your failed EC2 Linux instance - A tech blog for Cloud Admins, by a Cloud Admin</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A tech blog from a Cloud Admin about system administration, Cloud technologies and DevOps"><meta name=author content="Aditya Krishnakumar"><meta property="og:title" content="Fix RootFS related errors in your failed EC2 Linux instance"><meta property="og:description" content="TLDR; If you face the RootFS related issue, try to check whether the AMI was having an older version of the Linux kernel. If it does, chroot into your volume and perform a kernel upgrade."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.beingadityak.com/posts/fix-rootfs-ec2/"><meta property="article:published_time" content="2020-10-25T19:05:44+05:30"><meta property="article:modified_time" content="2020-10-25T19:05:44+05:30"><meta name=twitter:card content="summary"><meta name=twitter:title content="Fix RootFS related errors in your failed EC2 Linux instance"><meta name=twitter:description content="TLDR; If you face the RootFS related issue, try to check whether the AMI was having an older version of the Linux kernel. If it does, chroot into your volume and perform a kernel upgrade."><meta name=generator content="Hugo 0.76.5"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://blog.beingadityak.com/fontawesome/css/all.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda"><link rel=stylesheet type=text/css href=https://blog.beingadityak.com/css/styles.css></head><body><div id=container><header><h1><a href=https://blog.beingadityak.com/>The Ops Blog</a></h1><ul id=social-media><li><a href=https://github.com/beingadityak title=GitHub><i class="fab fa-github fa-lg"></i></a></li><li><a href=https://twitter.com/beingadityak_ title=Twitter><i class="fab fa-twitter fa-lg"></i></a></li><li><a href=https://linkedin.com/in/beingadityak title=LinkedIn><i class="fab fa-linkedin fa-lg"></i></a></li></ul><p><em>A tech blog for Cloud Admins, by a Cloud Admin</em></p></header><nav><ul></ul></nav><main><article><h1>Fix RootFS related errors in your failed EC2 Linux instance</h1><aside><ul><li><time class=post-date datetime=2020-10-25T19:05:44+05:30>Oct 25, 2020</time></li><li>Categories:
<em><a href=https://blog.beingadityak.com/categories/ec2>ec2</a>
,
<a href=https://blog.beingadityak.com/categories/troubleshooting>troubleshooting</a>
,
<a href=https://blog.beingadityak.com/categories/linux>linux</a></em></li><li>4 minutes read</li></ul></aside><div class=featured_image><a href=https://blog.beingadityak.com/posts/fix-rootfs-ec2/ title="Fix RootFS related errors in your failed EC2 Linux instance"><img src></a></div><p><img src=https://blog.beingadityak.com/posts/fix-rootfs-ec2/ec2-front.jpeg alt="Amazon EC2"></p><h2 id=tldr>TLDR;</h2><p>If you face the RootFS related issue, try to check whether the AMI was having an older version of the Linux kernel. If it does, chroot into your volume and perform a kernel upgrade. Once done, detach the volume and create an AMI out of it. This will fix the 1/2 status checks issue.</p><h2 id=context>Context</h2><p>If you have worked with Amazon EC2 in the past, there might be a chance that sometimes the EC2 instance fails to launch after a fresh start/stop-start of the instance. It even might have happened that you tried to launch from a very old AMI (which someone shared with you/you migrated it from another account) and the instance fails the 2/2 checks thing.</p><p>The catch-all solution could be to simply terminate the instance and create a new one or maybe create a snapshot first (if that instance contains any database or similar). Sometimes there are some edge cases and the new instance which was recreated also fails the 2/2 checks. I’m discussing one of the scenarios where it fails due to a RootFS mount issue.</p><h2 id=the-scenario>The scenario</h2><p>In my case, I was performing a cross-account migration of AMIs between 2 AWS accounts. The instance was an Amazon Linux AMI (2017 version). I created the AMI and launched an instance from it successfully but it failed on the <em>&ldquo;Instance Reachability&rdquo;</em> status check. I tried to terminate the instance and relaunch a new instance out of the same AMI, thinking it might be something related to the server hardware (sometimes they launch your instance in a degraded hardware) but again it failed the check. I checked on the system log and it said:</p><pre><code>Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,0)
</code></pre><p>This cryptic message means that somehow the instance was unable to mount the EBS volume (in my case my instance type was having an EBS-backed volume).</p><p>On checking the <strong>&ldquo;Resolution&rdquo;</strong> section of the <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/TroubleshootingInstances.html#FilesystemKernel>troubleshooting page</a> it said the following:</p><pre><code>Stop and modify to use modern kernel
</code></pre><p>Not really helpful.</p><h2 id=the-resolution>The resolution</h2><p>After 10–15 minutes of searching around, I found a SO answer to update the kernel. However, you need to have the access of the system first to update the kernel in the first place.</p><p>Fortunately enough, my instance-type was having EBS-backed root volumes. So, I stopped the instance, detached it’s volume, created a recovery instance and attached the volume to the recovery instance. Also, make a note that simply attaching the volume to the instance doesn’t mean you can simply start reading from it. You need to create a mount point for your volume. This can be done by simply running these commands (run these from a root-level prompt):</p><pre><code>lsblk # To check whether the device is available in system or not
mkdir /data
mount /dev/xvdf1 /data # In my case the volume was mounted as /dev/xvdf1. Yours might vary
</code></pre><p>After mounting the volume, the challenge was to use the volume. This was possible using the <em>chroot</em> command. But first, you need to mount the required filesystem directories:</p><pre><code>mount -t proc none /data/proc # mount the processes in the volume
mount --rbind /sys /data/sys # Recursively mount system directories
mount --rbind /dev /data/dev # recursively mount all devices
</code></pre><p>Now, we’re ready to chroot as simple as:</p><pre><code>chroot /data /bin/bash
</code></pre><p>This will mount your bash shell to your volume’s filesystem as /.</p><p>Now, the kernel update (This is an Amazon Linux OS) was as simple as:</p><pre><code>yum update -y
yum install -y kernel
</code></pre><p>After the kernel was updated, I stopped my recovery instance, safely unmounted the volume and re-attached the volume back to the original instance. After starting the instance, Voila! The failing check passed and thus the day was saved.</p><h2 id=moral-of-the-story>Moral of the story</h2><p>Always make sure that you perform kernel upgrades in the regular intervals so that whenever you need an AMI, you know that you’ll be getting an AMI that will atleast not fail due to an outdated kernel.</p></article><section class=post-nav><ul><li><a href=https://blog.beingadityak.com/posts/paid-ssl-certs-nginx/>Setup paid SSL Certificates for your NGINX installation <i class="fa fa-chevron-circle-right"></i></a></li></ul></section><section class=comments-block><button id=show-comments style=display:none><i class="fa fa-comments"></i> Add/View Comments</button></section><section id=disqus_thread></section><script>(function(){if(window.location.hostname=="localhost")
return;var disqus_loaded=false;var disqus_shortname='beingadityak';var disqus_button=document.getElementById("show-comments");var disqus_autoload=null;var disable_comment=null;if(disable_comment)
return;disqus_button.style.display="";if(disqus_autoload){disqus();}else{disqus_button.addEventListener("click",disqus,false);}
function disqus(){if(!disqus_loaded){disqus_loaded=true;var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//"+disqus_shortname+".disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e);document.getElementById("show-comments").style.display="none";}}
var hash=window.location.hash.substr(1);if(hash.length>8){if(hash.substring(0,8)=="comment-"){disqus();}}
if(/bot|google|baidu|bing|msn|duckduckgo|slurp|yandex/i.test(navigator.userAgent)){disqus();}})();</script></main><footer><h6>Copyright © 2020 - Aditya Krishnakumar |
Rendered by <a href=https://gohugo.io title=Hugo>Hugo</a> |
<a href=https://blog.beingadityak.com/index.xml>Subscribe</a></h6></footer></div><script src=https://blog.beingadityak.com/js/scripts.js></script></body></html>